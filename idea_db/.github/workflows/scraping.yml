name: ã‚¤ãƒã‚·ã‚¹ ã‚¢ã‚¤ãƒ‡ã‚¢åé›†ã‚·ã‚¹ãƒ†ãƒ 

on:
  # æœˆæ¬¡å®Ÿè¡Œï¼ˆæ¯æœˆ1æ—¥ã®åˆå‰2æ™‚ï¼‰
  schedule:
    - cron: '0 2 1 * *'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      platform:
        description: 'å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆç©ºç™½ã§å…¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰'
        required: false
        type: choice
        options:
          - 'all'
          - 'n8n'
          - 'zapier'
          - 'make'
          - 'powerAutomate'
          - 'awesomeSelfhosted'
          - 'awesomeN8n'
          - 'ifttt'
          - 'airtable'
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ãªã—ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  scraping:
    runs-on: ubuntu-latest
    
    env:
      GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
      GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
      GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
      GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
      DEBUG_MODE: true
      LOG_LEVEL: info

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: idea_db/package-lock.json
        
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      working-directory: ./idea_db
      run: npm ci
      
    - name: Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      working-directory: ./idea_db
      run: npx playwright install chromium
      
    - name: ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
      working-directory: ./idea_db
      run: |
        if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
          npm run scrape test
        elif [ -n "${{ github.event.inputs.platform }}" ] && [ "${{ github.event.inputs.platform }}" != "all" ]; then
          echo "ğŸ¯ å˜ä¸€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å®Ÿè¡Œ: ${{ github.event.inputs.platform }}"
          npm run scrape single ${{ github.event.inputs.platform }}
        else
          echo "ğŸš€ å…¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å®Ÿè¡Œ"
          npm start
        fi
      
    - name: çµæœãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: scraping-results-${{ github.run_number }}
        path: |
          idea_db/raw_data.csv
          idea_db/statistics.csv
        retention-days: 30
        
    - name: å®Ÿè¡Œã‚µãƒãƒªãƒ¼ä½œæˆ
      if: always()
      working-directory: ./idea_db
      run: |
        echo "## ğŸ“Š ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "- å®Ÿè¡Œæ—¥æ™‚: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.test_mode == 'true' && 'ãƒ†ã‚¹ãƒˆ' || (github.event.inputs.platform && github.event.inputs.platform != 'all' && 'å˜ä¸€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ') || 'å…¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ' }}" >> $GITHUB_STEP_SUMMARY
        if [ -f "raw_data.csv" ]; then
          echo "- ç·ãƒ‡ãƒ¼ã‚¿æ•°: $(wc -l < raw_data.csv)" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f "statistics.csv" ]; then
          echo "### ğŸ“ˆ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat statistics.csv >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

  notify:
    needs: scraping
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: å®Ÿè¡Œçµæœé€šçŸ¥
      if: success()
      run: |
        echo "âœ… ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        
    - name: ã‚¨ãƒ©ãƒ¼é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" 